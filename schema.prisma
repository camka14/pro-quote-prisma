// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

generator client_next {
  provider = "prisma-client"
  output   = "../pro-quote-next/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     String         @id @default(cuid())
  email                  String         @unique
  passwordHash           String
  name                   String?
  defaultCompanyId       String?
  defaultCompany         Company?       @relation("DefaultCompany", fields: [defaultCompanyId], references: [id])
  customChecklist        Json?
  weeklyGoals            Json?
  freeQuotesUsed         Int            @default(0)
  freeVisualizationsUsed Int            @default(0)
  subscriptionStatus     String         @default("inactive")
  subscriptionId         String?
  lastLogin              DateTime?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  memberships            Membership[]
  ownedCompanies         Company[]      @relation("OwnedCompanies")
  customers              Customer[]
  projects               Project[]
  quotes                 Quote[]
  invoices               Invoice[]
  installments           Installment[]
  subscriptions          Subscription[]
  aiJobs                 AiJob[]
  usageLogs              UsageLog[]
  sharedLinks            SharedLink[]
  stripeIds              StripeId[]
  estimates              Estimate[]
  files                  File[]
  webExtensionExports    WebExtensionExport[]
}

model Company {
  id                String             @id @default(cuid())
  name              String
  ownerId           String
  owner             User               @relation("OwnedCompanies", fields: [ownerId], references: [id])
  logoId            String?
  address           String?
  phone             String?
  website           String?
  isPersonal        Boolean?           @default(false)
  isSystem          Boolean            @default(false) // true for admin/global team
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  defaultForUsers   User[]             @relation("DefaultCompany")
  memberships       Membership[]
  teams             CompanyTeam[]
  customers         Customer[]
  projects          Project[]
  projectNotes      ProjectNote[]
  quotes            Quote[]
  quoteContents     QuoteContent[]
  invoices          Invoice[]
  installments      Installment[]
  stripeIds         StripeId[]
  aiJobs            AiJob[]
  estimates         Estimate[]
  estimateDivisions EstimateDivision[]
  estimateLineItems EstimateLineItem[]
  sharedLinks       SharedLink[]
  files             File[]
}

model Membership {
  id        String         @id @default(cuid())
  userId    String?
  companyId String
  teamId    String?
  email     String?
  status    MembershipStatus @default(accepted)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  user      User?          @relation(fields: [userId], references: [id])
  company   Company        @relation(fields: [companyId], references: [id])
  team      CompanyTeam?   @relation(fields: [teamId], references: [id])

  @@unique([userId, companyId])
  @@unique([companyId, email])
}

enum MembershipStatus {
  pending
  accepted
  rejected
}

model CompanyTeam {
  id          String        @id @default(cuid())
  companyId   String
  name        String
  permissions Json
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  company     Company       @relation(fields: [companyId], references: [id])
  members     Membership[]

  @@index([companyId])
}

model StripeId {
  id               String   @id @default(cuid())
  companyId        String?
  userId           String
  stripeCustomerId String?
  stripeAccountId  String?
  lastEvent        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id])
  company          Company? @relation(fields: [companyId], references: [id])

  @@unique([userId])
  @@index([companyId])
}

model Customer {
  id        String    @id @default(cuid())
  userId    String
  companyId String
  name      String
  email     String?
  address   String?
  street1   String?
  street2   String?
  city      String?
  state     String?
  zipCode   String?
  country   String?
  phone     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id])
  company   Company   @relation(fields: [companyId], references: [id])
  projects  Project[]
}

model Project {
  id             String       @id @default(cuid())
  userId         String
  companyId      String
  customerId     String
  projectType    String
  description    String?
  street1        String?
  street2        String?
  city           String?
  state          String?
  zipCode        String?
  country        String?
  status         String?      @default("LEAD")
  notes          String[]
  referenceFiles String[]
  siteChecklist  Json?
  aiInsights     Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User         @relation(fields: [userId], references: [id])
  company        Company      @relation(fields: [companyId], references: [id])
  customer       Customer     @relation(fields: [customerId], references: [id])
  quotes         Quote[]
  sharedLinks    SharedLink[]
  estimates      Estimate[]
}

model ProjectNote {
  id        String   @id @default(cuid())
  companyId String
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id])
}

model Quote {
  id          String        @id @default(cuid())
  userId      String
  companyId   String
  imageUrl    String?
  estimateId  String?
  totalAmount Decimal?      @db.Decimal(18, 2)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])
  company     Company       @relation(fields: [companyId], references: [id])
  content     QuoteContent?
  estimate    Estimate?     @relation(fields: [estimateId], references: [id])
  invoices    Invoice[]
  project     Project?      @relation(fields: [projectId], references: [id])
  projectId   String?
}

model QuoteContent {
  id              String   @id @default(cuid())
  companyId       String
  content         String?
  quoteId         String?  @unique
  additionalNotes String?
  breakdown       Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  company         Company  @relation(fields: [companyId], references: [id])
  quote           Quote?   @relation(fields: [quoteId], references: [id])
}

model Invoice {
  id               String        @id @default(cuid())
  userId           String
  companyId        String
  quoteId          String
  invoiceNumber    String?
  issueDate        DateTime?
  totalAmountCents Int
  currency         String
  status           String        @default("pending")
  stripeAccountId  String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  user             User          @relation(fields: [userId], references: [id])
  company          Company       @relation(fields: [companyId], references: [id])
  quote            Quote         @relation(fields: [quoteId], references: [id])
  installments     Installment[]

  @@index([quoteId])
  @@index([status])
}

model Installment {
  id                    String    @id @default(cuid())
  userId                String
  companyId             String
  invoiceId             String
  amountCents           Int
  currency              String
  dueDate               DateTime
  status                String    @default("pending")
  stripeLink            String?
  stripePaymentLinkId   String?
  stripePaymentIntentId String?
  stripeSessionId       String?
  paidAt                DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id])
  company               Company   @relation(fields: [companyId], references: [id])
  invoice               Invoice   @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([status])
  @@index([stripePaymentLinkId])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String
  stripeSubscriptionId String?
  status               String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAt             DateTime?
  canceledAt           DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  trialStart           DateTime?
  trialEnd             DateTime?
  lastEvent            String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id])
}

model UsageLog {
  id        String    @id @default(cuid())
  userId    String
  type      String
  revenue   Decimal   @default(0) @db.Decimal(18, 4)
  cost      Decimal   @default(0) @db.Decimal(18, 4)
  timestamp DateTime?
  date      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id])
}

model AiJob {
  id             String   @id @default(cuid())
  userId         String
  companyId      String?
  action         String
  status         String
  statusMessage  String?
  payloadSummary String?
  result         String?
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
  company        Company? @relation(fields: [companyId], references: [id])
}

model Estimate {
  id                 String             @id @default(cuid())
  estimateName       String
  userId             String
  companyId          String
  projectId          String?
  divisionIds        String[]
  previousResponseId String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  user               User               @relation(fields: [userId], references: [id])
  company            Company            @relation(fields: [companyId], references: [id])
  project            Project?           @relation(fields: [projectId], references: [id])
  divisions          EstimateDivision[]
  quotes             Quote[]
}

model EstimateDivision {
  id           String                     @id @default(cuid())
  estimateId   String?
  companyId    String
  divisionName String
  followUps    Json?
  laborHours   Float                      @default(0)
  laborRate    Float                      @default(0)
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt
  estimate     Estimate?                  @relation(fields: [estimateId], references: [id])
  company      Company                    @relation(fields: [companyId], references: [id])
  lineItems    EstimateDivisionLineItem[]
}

model EstimateLineItem {
  id            String                     @id @default(cuid())
  name          String
  csiDivision   String?
  csiSection    String?
  csiSubsection String?
  companyId     String
  productUrl    String?
  followUps     Json?
  price         Decimal                    @default(0) @db.Decimal(18, 4)
  markupPercent Decimal                    @default(0) @db.Decimal(8, 4)
  addTax        Boolean                    @default(false)
  taxPercent    Decimal                    @default(0) @db.Decimal(8, 4)
  units         String
  quantity      Decimal                    @default(0) @db.Decimal(18, 4)
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  company       Company                    @relation(fields: [companyId], references: [id])
  divisions     EstimateDivisionLineItem[]
}

model EstimateDivisionLineItem {
  id                 String           @id @default(cuid())
  estimateDivisionId String
  lineItemId         String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  division           EstimateDivision @relation(fields: [estimateDivisionId], references: [id])
  lineItem           EstimateLineItem @relation(fields: [lineItemId], references: [id])

  @@unique([estimateDivisionId, lineItemId])
}

model SharedLink {
  id               String   @id @default(cuid())
  userId           String
  companyId        String
  projectId        String?
  estimateIds      String[]
  divisionIds      String[]
  lineItemIds      String[]
  recipientEmails  String[]
  emailPermissions String?
  sharedData       Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id])
  company          Company  @relation(fields: [companyId], references: [id])
  project          Project? @relation(fields: [projectId], references: [id])
}

model File {
  id           String   @id @default(cuid())
  companyId    String?
  uploaderId   String?
  bucket       String?
  originalName String
  mimeType     String?
  sizeBytes    Int?
  path         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company? @relation(fields: [companyId], references: [id])
  uploader     User?    @relation(fields: [uploaderId], references: [id])
}

model WebExtensionExport {
  id         String   @id @default(cuid())
  userId     String?
  userEmail  String
  siteOrigin String
  runId      String
  url        String
  startedAt  DateTime
  endedAt    DateTime?
  pagesSeen  Int
  groupCount Int
  recordCount Int
  capture    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userEmail])
  @@index([siteOrigin])
  @@index([runId])
}
