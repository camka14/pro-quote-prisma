// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     String         @id @default(cuid())
  email                  String         @unique
  passwordHash           String
  name                   String?
  defaultCompanyId       String?
  defaultCompany         Company?       @relation("DefaultCompany", fields: [defaultCompanyId], references: [id])
  customChecklist        Json?
  weeklyGoals            Json?
  freeQuotesUsed         Int            @default(0)
  freeVisualizationsUsed Int            @default(0)
  subscriptionStatus     String         @default("inactive")
  subscriptionId         String?
  lastLogin              DateTime?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  memberships            Membership[]
  ownedCompanies         Company[]      @relation("OwnedCompanies")
  customers              Customer[]
  vendors                Vendor[]
  projects               Project[]
  quotes                 Quote[]
  invoices               Invoice[]
  installments           Installment[]
  subscriptions          Subscription[]
  aiJobs                 AiJob[]
  usageLogs              UsageLog[]
  sharedLinks            SharedLink[]
  stripeIds              StripeId[]
  budgets              Budget[]
  files                  File[]
  webExtensionExports    WebExtensionExport[]
  documentTemplateVersions DocumentTemplateVersion[]
  documentsCreated         Document[]
  documentVersionsCreated  DocumentVersion[]
  documentEvents           DocumentEvent[]
  documentSigningRequests  DocumentSigningRequest[]
  documentSigners          DocumentSigner[]
}

model Company {
  id                String             @id @default(cuid())
  name              String
  ownerId           String
  owner             User               @relation("OwnedCompanies", fields: [ownerId], references: [id])
  logoId            String?
  address           String?
  phone             String?
  website           String?
  isPersonal        Boolean?           @default(false)
  isSystem          Boolean            @default(false) // true for admin/global team
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  defaultForUsers   User[]             @relation("DefaultCompany")
  memberships       Membership[]
  roles             Role[]
  customers         Customer[]
  vendors           Vendor[]
  projects          Project[]
  projectNotes      ProjectNote[]
  quotes            Quote[]
  quoteContents     QuoteContent[]
  invoices          Invoice[]
  installments      Installment[]
  stripeIds         StripeId[]
  aiJobs            AiJob[]
  budgets         Budget[]
  budgetDivisions BudgetDivision[]
  budgetLineItems BudgetLineItem[]
  sharedLinks       SharedLink[]
  files             File[]
  documentTemplates DocumentTemplate[]
  documents         Document[]
}

model Membership {
  id        String         @id @default(cuid())
  userId    String?
  companyId String
  roleId    String?
  email     String?
  status    MembershipStatus @default(accepted)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  user      User?          @relation(fields: [userId], references: [id])
  company   Company        @relation(fields: [companyId], references: [id])
  role      Role?          @relation(fields: [roleId], references: [id])

  @@unique([userId, companyId])
  @@unique([companyId, email])
}

enum MembershipStatus {
  pending
  accepted
  rejected
}

enum DocumentType {
  CONTRACT
  CHANGE_ORDER
  PURCHASE_ORDER
  WORK_ORDER
  WARRANTY
  QUOTE
}

enum DocumentStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  SIGNED
  VOIDED
}

model Role {
  id          String        @id @default(cuid())
  companyId   String
  name        String
  permissions Json
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  company     Company       @relation(fields: [companyId], references: [id])
  memberships Membership[]
  customers   Customer[]
  vendors     Vendor[]

  @@index([companyId])
}

model StripeId {
  id               String   @id @default(cuid())
  companyId        String?
  userId           String
  stripeCustomerId String?
  stripeAccountId  String?
  lastEvent        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id])
  company          Company? @relation(fields: [companyId], references: [id])

  @@unique([userId])
  @@index([companyId])
}

model Customer {
  id        String    @id @default(cuid())
  userId    String
  companyId String
  roleId    String?
  name      String
  email     String?
  address   String?
  street1   String?
  street2   String?
  city      String?
  state     String?
  zipCode   String?
  country   String?
  phone     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id])
  company   Company   @relation(fields: [companyId], references: [id])
  role      Role?     @relation(fields: [roleId], references: [id])
  projects  Project[]
  sharedLinks SharedLink[]

  @@index([roleId], map: "Customer_roleId_idx")
}

model Vendor {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  roleId    String?
  name      String
  email     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  company   Company  @relation(fields: [companyId], references: [id])
  role      Role?    @relation(fields: [roleId], references: [id])

  @@index([companyId])
  @@index([roleId])
}

model Project {
  id             String       @id @default(cuid())
  userId         String
  companyId      String
  customerId     String
  name           String?
  projectType    String
  description    String?
  street1        String
  street2        String?
  city           String
  state          String
  zipCode        String
  country        String
  status         String?      @default("LEAD")
  notes          String[]
  referenceFiles String[]
  siteChecklist  Json?
  aiInsights     Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User         @relation(fields: [userId], references: [id])
  company        Company      @relation(fields: [companyId], references: [id])
  customer       Customer     @relation(fields: [customerId], references: [id])
  quotes         Quote[]
  sharedLinks    SharedLink[]
  budgets      Budget[]
  documents     Document[]
}

model ProjectNote {
  id        String   @id @default(cuid())
  companyId String
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id])
}

model Quote {
  id          String        @id @default(cuid())
  userId      String
  companyId   String
  imageUrl    String?
  budgetId  String?
  totalAmount Decimal?      @db.Decimal(18, 2)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])
  company     Company       @relation(fields: [companyId], references: [id])
  content     QuoteContent?
  budget    Budget?     @relation(fields: [budgetId], references: [id])
  invoices    Invoice[]
  project     Project?      @relation(fields: [projectId], references: [id])
  projectId   String?
}

model QuoteContent {
  id              String   @id @default(cuid())
  companyId       String
  content         String?
  quoteId         String?  @unique
  additionalNotes String?
  breakdown       Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  company         Company  @relation(fields: [companyId], references: [id])
  quote           Quote?   @relation(fields: [quoteId], references: [id])
}

model Invoice {
  id               String        @id @default(cuid())
  userId           String
  companyId        String
  quoteId          String
  invoiceNumber    String?
  issueDate        DateTime?
  totalAmountCents Int
  currency         String
  status           String        @default("pending")
  stripeAccountId  String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  user             User          @relation(fields: [userId], references: [id])
  company          Company       @relation(fields: [companyId], references: [id])
  quote            Quote         @relation(fields: [quoteId], references: [id])
  installments     Installment[]

  @@index([quoteId])
  @@index([status])
}

model Installment {
  id                    String    @id @default(cuid())
  userId                String
  companyId             String
  invoiceId             String
  amountCents           Int
  currency              String
  dueDate               DateTime
  status                String    @default("pending")
  stripeLink            String?
  stripePaymentLinkId   String?
  stripePaymentIntentId String?
  stripeSessionId       String?
  paidAt                DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id])
  company               Company   @relation(fields: [companyId], references: [id])
  invoice               Invoice   @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([status])
  @@index([stripePaymentLinkId])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String
  stripeSubscriptionId String?
  status               String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAt             DateTime?
  canceledAt           DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  trialStart           DateTime?
  trialEnd             DateTime?
  lastEvent            String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id])
}

model UsageLog {
  id        String    @id @default(cuid())
  userId    String
  type      String
  revenue   Decimal   @default(0) @db.Decimal(18, 4)
  cost      Decimal   @default(0) @db.Decimal(18, 4)
  timestamp DateTime?
  date      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id])
}

model AiJob {
  id             String   @id @default(cuid())
  userId         String
  companyId      String?
  action         String
  status         String
  statusMessage  String?
  payloadSummary String?
  result         String?
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
  company        Company? @relation(fields: [companyId], references: [id])
}

model Budget {
  id                 String             @id @default(cuid())
  userId             String
  companyId          String
  projectId          String?
  divisionIds        String[]
  previousResponseId String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  user               User               @relation(fields: [userId], references: [id])
  company            Company            @relation(fields: [companyId], references: [id])
  project            Project?           @relation(fields: [projectId], references: [id])
  divisions          BudgetDivision[]
  quotes             Quote[]
}

model BudgetDivision {
  id           String                     @id @default(cuid())
  budgetId   String?
  companyId    String
  divisionName String
  followUps    Json?
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt
  budget     Budget?                  @relation(fields: [budgetId], references: [id])
  company      Company                    @relation(fields: [companyId], references: [id])
  lineItems    BudgetDivisionLineItem[]
}

model BudgetLineItem {
  id            String                     @id @default(cuid())
  name          String
  csiDivision   String?
  csiSection    String?
  csiSubsection String?
  companyId     String
  productUrl    String?
  followUps     Json?
  price         Decimal                    @default(0) @db.Decimal(18, 4)
  markupPercent Decimal                    @default(0) @db.Decimal(8, 4)
  addTax        Boolean                    @default(false)
  taxPercent    Decimal                    @default(0) @db.Decimal(8, 4)
  units         String
  quantity      Decimal                    @default(0) @db.Decimal(18, 4)
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  company       Company                    @relation(fields: [companyId], references: [id])
  divisions     BudgetDivisionLineItem[]
}

model BudgetDivisionLineItem {
  id                 String           @id @default(cuid())
  budgetDivisionId String
  lineItemId         String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  division           BudgetDivision @relation(fields: [budgetDivisionId], references: [id])
  lineItem           BudgetLineItem @relation(fields: [lineItemId], references: [id])

  @@unique([budgetDivisionId, lineItemId])
}

model SharedLink {
  id               String   @id @default(cuid())
  userId           String
  companyId        String
  projectId        String?
  customerId       String?
  budgetIds      String[]
  divisionIds      String[]
  lineItemIds      String[]
  sharedData       Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id])
  company          Company  @relation(fields: [companyId], references: [id])
  project          Project? @relation(fields: [projectId], references: [id])
  customer         Customer? @relation(fields: [customerId], references: [id])

  @@index([customerId], map: "SharedLink_customerId_idx")
}

model File {
  id           String   @id @default(cuid())
  companyId    String?
  uploaderId   String?
  bucket       String?
  originalName String
  mimeType     String?
  sizeBytes    Int?
  path         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company? @relation(fields: [companyId], references: [id])
  uploader     User?    @relation(fields: [uploaderId], references: [id])
  documentVersionPdfs DocumentVersion[] @relation("DocumentVersionPdfFile")
  documentAttachments DocumentAttachment[]
}

model DocumentTemplate {
  id        String       @id @default(cuid())
  companyId String
  type      DocumentType
  name      String
  status    String       @default("ACTIVE")
  isDefault Boolean      @default(false)
  boldsignTemplateId String?
  signerRoles Json?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  company   Company      @relation(fields: [companyId], references: [id])
  versions  DocumentTemplateVersion[]

  @@index([companyId])
  @@index([type])
}

model DocumentTemplateVersion {
  id            String   @id @default(cuid())
  templateId    String
  versionNumber Int
  bodyHtml      String
  schemaJson    Json?
  createdById   String
  createdAt     DateTime @default(now())
  template      DocumentTemplate @relation(fields: [templateId], references: [id])
  createdBy     User     @relation(fields: [createdById], references: [id])
  documentVersions DocumentVersion[]

  @@unique([templateId, versionNumber])
  @@index([templateId])
  @@index([createdById])
}

model Document {
  id               String         @id @default(cuid())
  companyId         String
  projectId         String
  type             DocumentType
  number           String?
  status           DocumentStatus @default(DRAFT)
  signingRequired  Boolean        @default(false)
  boldsignTemplateId String?
  signerRoles      Json?
  signingFields    Json?
  currentVersionId String?        @unique
  counterpartyType String?
  counterpartyId   String?
  totalAmount      Decimal?       @db.Decimal(18, 2)
  createdById      String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  company          Company        @relation(fields: [companyId], references: [id])
  project          Project        @relation(fields: [projectId], references: [id])
  createdBy        User           @relation(fields: [createdById], references: [id])
  currentVersion   DocumentVersion? @relation("DocumentCurrentVersion", fields: [currentVersionId], references: [id])
  versions         DocumentVersion[] @relation("DocumentVersions")
  attachments      DocumentAttachment[]
  events           DocumentEvent[]
  signingRequests  DocumentSigningRequest[]
  signers          DocumentSigner[]
  shareLinks       DocumentShareLink[]

  @@index([companyId, projectId])
  @@index([status])
}

model DocumentVersion {
  id                String   @id @default(cuid())
  documentId        String
  versionNumber     Int
  templateVersionId String?
  renderedHtml      String
  dataSnapshotJson  Json?
  pdfFileId         String?
  createdById       String
  createdAt         DateTime @default(now())
  document          Document @relation("DocumentVersions", fields: [documentId], references: [id])
  currentFor       Document? @relation("DocumentCurrentVersion")
  templateVersion   DocumentTemplateVersion? @relation(fields: [templateVersionId], references: [id])
  pdfFile           File?    @relation("DocumentVersionPdfFile", fields: [pdfFileId], references: [id])
  createdBy         User     @relation(fields: [createdById], references: [id])
  attachments       DocumentAttachment[]

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@index([templateVersionId])
  @@index([pdfFileId])
}

model DocumentAttachment {
  id               String   @id @default(cuid())
  documentId       String
  documentVersionId String?
  fileId           String
  label            String?
  createdAt        DateTime @default(now())
  document         Document @relation(fields: [documentId], references: [id])
  documentVersion  DocumentVersion? @relation(fields: [documentVersionId], references: [id])
  file             File     @relation(fields: [fileId], references: [id])

  @@index([documentId])
  @@index([documentVersionId])
  @@index([fileId])
}

model DocumentEvent {
  id          String   @id @default(cuid())
  documentId  String
  eventType   String
  actorUserId String?
  metadataJson Json?
  createdAt   DateTime @default(now())
  document    Document @relation(fields: [documentId], references: [id])
  actorUser   User?    @relation(fields: [actorUserId], references: [id])

  @@index([documentId])
  @@index([actorUserId])
}

model DocumentSigningRequest {
  id                String   @id @default(cuid())
  documentId        String
  templateId        String?
  boldsignTemplateId String?
  boldsignDocumentId String
  status            String   @default("pending")
  createdById       String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  document          Document @relation(fields: [documentId], references: [id])
  createdBy         User     @relation(fields: [createdById], references: [id])
  signers           DocumentSigner[]

  @@index([documentId])
  @@index([boldsignDocumentId])
  @@index([createdById])
}

model DocumentSigner {
  id                String   @id @default(cuid())
  signingRequestId  String
  documentId        String
  roleName          String?
  roleIndex         Int?
  signerName        String
  signerEmail       String
  signerUserId      String?
  signingOrder      Int?
  status            String   @default("pending")
  signedAt          DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  signingRequest    DocumentSigningRequest @relation(fields: [signingRequestId], references: [id])
  document          Document @relation(fields: [documentId], references: [id])
  signerUser        User?    @relation(fields: [signerUserId], references: [id])

  @@index([signingRequestId])
  @@index([documentId])
  @@index([signerUserId])
  @@index([signerEmail])
}

model DocumentShareLink {
  id          String   @id @default(cuid())
  documentId  String
  companyId   String
  createdById String
  recipients  Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  document    Document @relation(fields: [documentId], references: [id])
  company     Company  @relation(fields: [companyId], references: [id])
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([documentId])
  @@index([companyId])
  @@index([createdById])
}

model WebExtensionExport {
  id         String   @id @default(cuid())
  userId     String?
  userEmail  String
  siteOrigin String
  runId      String
  url        String
  startedAt  DateTime
  endedAt    DateTime?
  pagesSeen  Int
  groupCount Int
  recordCount Int
  schemaVersion Int @default(1)
  pageType    String?
  capture    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userEmail])
  @@index([siteOrigin])
  @@index([runId])
}
